

### 文件目录权限
长格式显示的时候，此10位代表文件或者目录的权限
~~~
-rwxr--r--.
~~~
最后一个点，是代表所受selinux增强保护，

第一位，代表文件类型

~~~
-   代表普通文件
d   代表目录
l   代表软链接
b   块设备文件，存储设备文件为此格式，u盘，硬盘等
~~~

~~~
r  读权限
w  写权限
x  执行权限
~~~
可以用数字来表示，4表示r, 2表示w, 1表示x

第2-4位，所有者权限
第5-7位，所属组权限
第8-10位，其他人权限

权限命令
~~~shell
chmod [ugoa][+-=][rwx]  xxx

赋予123文件所有者执行权限
chmod u+x 123
赋予123文件所有者读写权限，其他读权限
chmod 644 123
~~~

目录权限，只有0，5，7权限，目录的x权限，代表可以cd进入目录
对于删除文件，必须对上级目录有w的权限，文件名保存在上级目录i节点

修改所有者和所有组
~~~shell
chown       修改所有者，所有组
chgrp       修改所有组

chown user xxx      修改xxx文件的所有者为xxx
chown user:user xxx 修改xxx文件的所有者和所有组为user
chown user.user xxx 所有者和文件组中间用: 或者. 连接
~~~


#### 默认权限

~~~
umask
~~~

umask默认 022 ，对应的默认文件权限644，默认目录权限755

umask值计算 默认权限
* 文件：文件最大默认权限 666 减去 022 得到 644
* 目录：目录最大默认权限 777 减去 022 得到 755

#### 权限对文件和目录的作用

文件最大默认权限666，即新建文件默认不能有执行权限，只能通过 chmod 添加文件的 执行权限
目录最大默认权限777，目录的 x 权限仅仅是能够进入目录



##### 文件

* r 能够读取文件内容
* w 能够修改文件内容
* x 能够执行文件，能否执行成功取决于文件脚本得正确性

##### 目录

* r 对目录有读权限的时候，可以查看目录下有哪些内容，即可以使用 ls 命令查看目录下的有哪些子目录和文件  
* w 对目录有写权限，可以修改目录下的数据，即可以在目录下新建，复制，删除，剪切子目录或文件
* x 对目录有执行权限，因为目录不能执行，所以对目录有执行权限的时候，可以进入目录，即 cd 命令

对于目录来说，权限只有几个值有意义当权限为

* 权限为0(---)：任何权限都不赋予
* 权限为1(--x)：只能进入目录，什么也干不了，没有意义，即只有 cd 命令
* 权限为2(-w-)：因为没有目录的执行权限，所以不能读取目录下的状态，也不能目录下的文件，即新建，删除，复制等等，其实什么也干不了，没有意义
* 权限为3(-wx)：能进入目录，能操作文件，新建，删除等，但是不能查看目录下的文件，没有意义
* 权限为4(r--)：只能查看目录下的一级目录名字和文件名，因为文件名或目录名存在于上级目录中，没有意义
* 权限为5(r-x)：能进入目录，能查看目录下的文件和子目录，但是不能操作目录下文件，即不能创建，删除，复制文件
* 权限为6(rw-)：因为没有执行权限，不能进入cd，即不能读取目录下的文件状态，同4权限相同，只能查看目录下的文件和一级子目录名
* 权限为7(rwx)：最高权限，能进入目录，查看目录下文件，创建，删除，移动文件等

所以目录的有意义的权限只有 0 , 5 , 7


### 用户权限

#### 相关配置文件

~~~
/etc/passwd
/etc/shadow
/etc/group
/etc/gshadow
/root 或 /home/用户名
/var/spool/mail/用户名
/etc/skel
~~~



#### 用户信息文件
~~~
vi /etc/passwd

root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
...
~~~

* 第一列：用户名
* 第二列：密码位，有x代表有密码，密码在/etc/shadow文件中查看  
* 第三列：用户ID
  * 0：超级用户UID
  * 1-499：系统用户(伪用户)uid
  * 500-65535：普通用户UID
* 第四列：初始组ID,新建用户时会建立同名组，用户组信息在/etc/group文件中查看
* 第五列：用户说明
* 第六列：用户家目录，超级用户/root，普通用户/home下 
* 第七列：登陆shell， /bin/bash能登陆，/sbin/nologin不能登陆 等...


#### 用户影子文件(密码文件)

~~~
vi /etc/shadow

root:$1$K1WU5zcrME$Hx21nlgRmqkrYx0D3eY7mEgWi1:18492:0:99999:7:::
bin:*:17110:0:99999:7:::
...

~~~
文件权限为 000 ，只有root用户能修改，切强制保存 :wq! 才能生效

* 第一列：di用户名
* 第二列：加密后的密码(sha512)，所有伪用户都是不能登陆的，密码为 * 或 !! 可以在某个用户密码前加一个 ! 临时限制登陆
* 第三列：密码最近更改时间，时间戳，对于1970年1月1日过去的天数
* 第四列：两次密码修改的间隔时间，默认为0，可以修改密码，例:设为5，则5天内不能修改密码，两次密码修改间隔必须大于5天
* 第五列：密码有效期，默认99999，永久生效，基于第三列
* 第六列：密码到期前的警告天数，基于第五列，还剩几天过期则每次登陆会警告
* 第七列：密码到期后的宽限天数，默认-1，在此文件中不显示即-1，永不过期，基于第五列
* 第八列：密码失效时间，如果超过此失效时间，无论密码有没有过期，都不能登陆，到期后，会在第二列密码前加一个 " ! "
* 第九列：保留


#### 组信息文件
~~~
/etc/group
~~~

* 第一列：组名
* 第二列：组密码位，密码位于 /etc/gshadow ，不建议给组添加密码
* 第三列：GID，组ID
* 第四列：组附加用户，只能看到组支持的附加用户

初始组：每个用户初始组有且只能有一个，一般都是和用户名相同的组作为初始组
附加组：每个用户可以属于多个附加组，要把用户加入组，都是加入附加组


#### 组影子文件(密码)

~~~
/etc/gshadow
~~~

#### 用户家目录

~~~
/root           root用户家目录
/home/用户名    普通用户家目录
~~~

#### 用户邮箱目录

~~~
/var/spool/mail/用户名
~~~

#### 用户模板目录

~~~
/etc/skel
~~~

每添加一个用户，会建立 /home/用户名 目录，会拷贝 /etc/skel 目录下的文件到 用户家目录




### 用户管理

#### 添加用户

~~~
useradd [选项] 用户名
    -u 数字     指定UID
    -g 组名     指定初始组，不建议手工指定，默认和用户名相同的组
    -G 组名     指定附加组
    -c 说明     添加说明
    -d 目录     手工指定家目录，目录不需要事先建立
    -s shell    指定shell，/bin/bash
~~~




添加用户的默认值配置文件
~~~
vi /etc/default/useradd

GROUP=100                 建立用户的默认组，现在猜用私有用户组机制
HOME=/home                默认家目录
INACTIVE=-1               密码过期后的第七个字段，/etc/shadow文件中的第七个字段，-1代表永不过期
EXPIRE=                   密码失效时间，建议手工设置
SHELL=/bin/bash           用户的默认shell
SKEL=/etc/skel            定义用户模板目录
CREATE_MAIL_SPOOL=yes     是否给新建用户建立邮箱



vi /etc/login.defs

MAIL_DIR        /var/spool/mail     邮箱位置
PASS_MAX_DAYS   99999               密码有效期
PASS_MIN_DAYS   0                   两次密码修改间隔
PASS_MIN_LEN    8                   密码最少位数，对root无效
PASS_WARN_AGE   7                   密码到期前警告天输
UID_MIN                  1000       UID最小值
UID_MAX                 60000       UID最大值
SYS_UID_MIN               201       系统伪用户UID最小值
SYS_UID_MAX               999       系统伪用户UID最大值
GID_MIN                  1000       GID最小值
GID_MAX                 60000       GID最大值
SYS_GID_MIN               201       系统组用户GID最小值
SYS_GID_MAX               999       系统组用户GID最大值
CREATE_HOME     yes                 新建用户是否自动建立家目录
UMASK           077                 新建家目录umask的值
USERGROUPS_ENAB yes                 删除用户时是否删除用户初始组   
ENCRYPT_METHOD SHA512               指定密码使用sha512加密                  
~~~


#### 用户密码修改

非root用户只有passwd 一条命令能使用，即修改自己密码

~~~
passwd          修改自己的密码
passwd 用户名   root用户修改其他用户密码，

passwd [选项] 用户名
    -l        暂时锁定用户，即在/etc/shadow文件的该用户的那一行的第二列密码前面加两个 !! (感叹号)，此用户就不能登陆
    -u        解锁用户，同理，会在 /etc/shadow该用户的那一行第二列去掉密码前面的两个 !! (感叹号)
    --stdin   可以将通过管道符输出的数据作为用户的密码，用于批量添加用户

例：给用户user1添加密码
echo "123" | useradd --stdin user1
~~~

对于新增的用户，让用户在第一次登陆之后强制修改密码，修改 /etc/shadow 文件中的该用户的 第三个字段(密码最近修改时间) 设为0，也可以用以下命令
~~~
chage -d 0 用户名
~~~


#### 用户信息修改

~~~
id 用户名   查看用户信息，UID，GID等
~~~

~~~
usermod [选项] 用户名
    -u UID        修改用户UID
    -d 目录       修改用户家目录，必须写绝对路径，即 /etc/passwd 的第六个字段
    -c 说明       修改用户说明，即 /etc/passwd 的第五列
    -g 组名       修改用户初始组，即 /etc/passwd 的第四个字段
    -G 组名       修改用户附加组，即把用户加入其他组
    -s shell      修改用户登陆shell
    -e 日期       修改用户失效日期，格式为(YYYY-MM-DD)，即 /etc/shadow 第八个字段
    -L            临时锁定用户
    -U            解锁用户
~~~

#### 删除用户

~~~
userdel [选项] 用户名
    -r      删除用户同时删除家目录
~~~


#### 切换用户

普通用户切换其他用户需要切换用户的密码，超级用户切换其他用户不需要密码
~~~
su [选项] 用户名
    -         连用户环境变量一起切换，
    -c 命令   仅执行一次命令，不切换用户

例:root用户切换user1用户
su - user1
~~~


### 组管理

~~~
groupadd [选项] 组名          添加组
    -g GID    指定组GID

groupdel 组名                 删除组
~~~


~~~
gpasswd [选项] 组名
    -a 用户名   把用户加入组
    -d 用户名   把用户从组中删除

例：把用户user1加入test1组
gpasswd -a user1 test1
~~~

改变有效组，用户必须已经在两个组里
有效组即 新建文件，文件的默认所属组
~~~
newgrp 组名
~~~












